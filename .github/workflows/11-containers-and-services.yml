name: 11. Containers and Services

# Containers provide consistent execution environments
# Service containers run services like databases for testing
# See: https://docs.github.com/en/actions/using-containerized-services

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Basic Container Usage
  basic-container:
    name: Run Job in Container
    runs-on: ubuntu-latest
    
    container:
      image: node:20-bookworm-slim
    
    steps:
      - name: Check environment
        run: |
          echo "Running inside container"
          node --version
          ls /.dockerenv && echo "✓ In Docker container"

  container-with-options:
    name: Container with Options
    runs-on: ubuntu-latest
    
    container:
      image: node:20
      env:
        NODE_ENV: production
      volumes:
        - my_volume:/data
      options: --cpus 1 --memory 512m
    
    steps:
      - name: Check configuration
        run: |
          echo "NODE_ENV: $NODE_ENV"
          echo "Container configured with resource limits"

  # Service Containers - Databases
  redis-service:
    name: Redis Service
    runs-on: ubuntu-latest
    container: node:20-bookworm-slim
    
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Install redis client
        run: |
          apt-get update && apt-get install -y redis-tools
      
      - name: Test Redis
        run: |
          redis-cli -h redis ping
          redis-cli -h redis SET greeting "Hello from Actions"
          redis-cli -h redis GET greeting

  postgres-service:
    name: PostgreSQL Service
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Test PostgreSQL
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d testdb -c '\l'
          PGPASSWORD=postgres psql -h localhost -U postgres -d testdb -c 'CREATE TABLE users (id SERIAL, name VARCHAR(50));'
          PGPASSWORD=postgres psql -h localhost -U postgres -d testdb -c 'SELECT * FROM users;'
        env:
          PGPASSWORD: postgres

  # Multiple Services
  multi-services:
    name: Multiple Services
    runs-on: ubuntu-latest
    container: node:20-bookworm-slim
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Install clients
        run: |
          apt-get update
          apt-get install -y redis-tools postgresql-client
      
      - name: Test both services
        run: |
          redis-cli -h redis ping
          PGPASSWORD=postgres pg_isready -h postgres -U postgres

  # Networking Differences
  networking-container:
    name: Container Networking
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: About container networking
        run: |
          echo "When job runs IN container:"
          echo "✓ Use service name as hostname (redis, postgres, etc)"
          echo "✓ No port mapping needed"
          echo "✓ All containers on same Docker network"
      
      - name: Test connection
        run: |
          apt-get update && apt-get install -y redis-tools
          redis-cli -h redis ping

  networking-runner:
    name: Runner Networking
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: About runner networking
        run: |
          echo "When job runs ON runner (not in container):"
          echo "✓ Use localhost as hostname"
          echo "✓ Must map ports"
          echo "✓ Access via mapped ports"
      
      - name: Test connection
        run: |
          sudo apt-get update && sudo apt-get install -y redis-tools
          redis-cli -h localhost ping

  # Integration Test Example
  integration-test:
    name: Integration Test with Database
    runs-on: ubuntu-latest
    container: node:20-bookworm-slim
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Install PostgreSQL client
        run: |
          apt-get update && apt-get install -y postgresql-client
      
      - name: Setup database
        run: |
          PGPASSWORD=testpass psql -h postgres -U testuser -d testdb -c '
            CREATE TABLE products (
              id SERIAL PRIMARY KEY,
              name VARCHAR(100),
              price DECIMAL(10,2)
            );'
      
      - name: Insert test data
        run: |
          PGPASSWORD=testpass psql -h postgres -U testuser -d testdb -c "
            INSERT INTO products (name, price) VALUES 
            ('Widget', 19.99),
            ('Gadget', 29.99),
            ('Doohickey', 9.99);"
      
      - name: Query results
        run: |
          PGPASSWORD=testpass psql -h postgres -U testuser -d testdb -c '
            SELECT * FROM products;'
      
      - name: Run application tests
        run: echo "Application tests would run here"

  # Health Checks
  health-checks:
    name: Service Health Checks
    runs-on: ubuntu-latest
    
    services:
      # Service with health check (recommended)
      redis-healthy:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: About health checks
        run: |
          echo "✓ Health checks ensure service is ready"
          echo "✓ Workflow waits for health check to pass"
          echo "✓ Prevents race conditions"
          echo "✓ Always use health checks in production"
      
      - name: Test service
        run: |
          sudo apt-get update && sudo apt-get install -y redis-tools
          redis-cli -h localhost ping