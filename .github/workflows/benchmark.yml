name: Linux Kernel Build Benchmark

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:

jobs:
  benchmark-build:
    name: Build on ${{ matrix.runner-size }}
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        include:
          - runner-size: "Standard (2-core)"
            runs-on: ubuntu-latest
            cost: 0.008
          - runner-size: "Large (4-core)"
            runs-on: 4-core
            cost: 0.016
          - runner-size: "Medium (8-core)"
            runs-on: 8-core
            cost: 0.032
          - runner-size: "XLarge (16-core)"
            runs-on: 16-core
            cost: 0.064
          - runner-size: "XXLarge (32-core)"
            runs-on: 32-core
            cost: 0.128
          - runner-size: "XXXLarge (64-core)"
            runs-on: 64-core
            cost: 0.256
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: torvalds/linux
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flex bison build-essential libssl-dev libelf-dev bc
      
      - name: Configure kernel (defconfig)
        run: make defconfig
      
      - name: Build kernel with timing
        id: build
        run: |
          echo "build_start=$(date +%s)" >> $GITHUB_OUTPUT
          time make -j$(nproc) 2>&1 | tee build.log
          echo "build_end=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Calculate build time
        id: timing
        run: |
          START_TIME=${{ steps.build.outputs.build_start }}
          END_TIME=${{ steps.build.outputs.build_end }}
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "duration_seconds=$DURATION" >> $GITHUB_OUTPUT
          echo "duration_human=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT
      
      - name: Get system info
        run: |
          DURATION_MINUTES=$(( (${{ steps.timing.outputs.duration_seconds }} + 59) / 60 ))
          TOTAL_COST=$(awk "BEGIN {printf \"%.4f\", ${{ matrix.cost }} * $DURATION_MINUTES}")
          echo "## System Information" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU cores:** $(nproc)" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU info:** $(lscpu | grep 'Model name' | cut -d':' -f2 | xargs)" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory:** $(free -h | grep Mem | awk '{print $2}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Build time:** ${{ steps.timing.outputs.duration_human }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cost:** \$$TOTAL_COST (at \$${{ matrix.cost }}/min)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - uses: actions/upload-artifact@v4
        with:
          name: vmlinux-${{ matrix.runner-size }}
          path: |
            vmlinux
            arch/x86/boot/bzImage
          retention-days: 7