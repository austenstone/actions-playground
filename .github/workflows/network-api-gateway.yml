name: API Gateway example

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  id-token: write  # Required for OIDC token
  contents: read

jobs:
  access-private-service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get GitHub OIDC Token
        id: get-token
        run: |
          # Request OIDC token from GitHub with custom audience
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            -H "Accept: application/json; api-version=2.0" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://ActionsOIDCGateway" | jq -r '.value')
          
          # Mask the token in logs
          echo "::add-mask::$OIDC_TOKEN"
          
          # Set as output for next steps
          echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

      - name: Call API Gateway - GET Example
        env:
          OIDC_TOKEN: ${{ steps.get-token.outputs.token }}
          APIM_URL: ${{ vars.APIM_GATEWAY_URL }}  # Set this in repository variables
        run: |
          echo "ðŸš€ Calling API Gateway..."
          
          # Make authenticated request to API Gateway (proxies to httpbin.org/get)
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            "$APIM_URL/get")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ðŸ“Š HTTP Status: $http_code"
          echo "ðŸ“¦ Response: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Successfully accessed private service!"
          else
            echo "âŒ Failed to access private service"
            exit 1
          fi

      - name: Call API Gateway - POST Example
        env:
          OIDC_TOKEN: ${{ steps.get-token.outputs.token }}
          APIM_URL: ${{ vars.APIM_GATEWAY_URL }}
        run: |
          echo "ðŸš€ Posting data to API Gateway..."
          
          # Make POST request with data (proxies to httpbin.org/post)
          response=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"message": "Hello from GitHub Actions!", "workflow": "${{ github.workflow }}", "repo": "${{ github.repository }}"}' \
            "$APIM_URL/post")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ðŸ“Š HTTP Status: $http_code"
          echo "ðŸ“¦ Response: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Successfully posted to private service!"
          else
            echo "âŒ Failed to post to private service"
            exit 1
          fi

      - name: Test Unauthorized Access (Should Fail)
        env:
          APIM_URL: ${{ vars.APIM_GATEWAY_URL }}
        run: |
          echo "ðŸ”’ Testing API Gateway security..."
          echo "Attempting to access without OIDC token (should be rejected)..."
          
          # Make request WITHOUT authentication token
          response=$(curl -s -w "\n%{http_code}" \
            -H "Content-Type: application/json" \
            "$APIM_URL/get")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ðŸ“Š HTTP Status: $http_code"
          echo "ðŸ“¦ Response: $body"
          
          # Verify that request was properly rejected
          if [ "$http_code" -eq 401 ] || [ "$http_code" -eq 403 ]; then
            echo "âœ… Security validated! Request properly rejected without authentication"
          else
            echo "âŒ SECURITY ISSUE: API Gateway accepted unauthenticated request!"
            echo "Expected 401 or 403, got $http_code"
            exit 1
          fi

      - name: Verify OIDC Claims (Optional Debug)
        env:
          OIDC_TOKEN: ${{ steps.get-token.outputs.token }}
        run: |
          echo "ðŸ” Decoding OIDC token claims..."
          
          # Decode JWT payload (base64)
          payload=$(echo "$OIDC_TOKEN" | cut -d'.' -f2)
          
          # Add padding if needed
          padding=$((4 - ${#payload} % 4))
          if [ $padding -ne 4 ]; then
            payload="${payload}$(printf '=' %.0s $(seq 1 $padding))"
          fi
          
          # Decode and pretty print
          echo "$payload" | base64 -d 2>/dev/null | jq '.' || echo "Unable to decode token"
