name: 05. Secrets & Variables

# Secrets: Encrypted values for sensitive data (tokens, passwords, API keys)
# Variables: Non-sensitive configuration values
# Environment Variables: Available at workflow, job, or step scope

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Workflow-level environment variables (available to all jobs)
env:
  APP_VERSION: '1.0.0'
  BUILD_NUMBER: ${{ github.run_number }}

jobs:
  # =====================================
  # Secrets Demo
  # =====================================
  secrets:
    name: Working with Secrets
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      # GITHUB_TOKEN is automatically provided - no setup needed
      - name: Use GITHUB_TOKEN
        run: |
          gh api /repos/${{ github.repository }} --jq '.name'
          echo "Stars: $(gh api /repos/${{ github.repository }} --jq '.stargazers_count')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Access custom secrets (define in repo Settings > Secrets and variables > Actions)
      - name: Custom Secrets
        env:
          MY_SECRET: ${{ secrets.MY_SECRET }}
        run: |
          echo "Secrets are masked in logs: $MY_SECRET"
          # Output: Secrets are masked in logs: ***
      
      # Security: Always use env vars for untrusted input
      - name: Safe Input Handling
        if: github.event_name == 'pull_request'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "PR Title: $PR_TITLE"
      
      # Conditional execution based on secret existence
      - name: Check Secret Exists
        env:
          OPTIONAL_SECRET: ${{ secrets.OPTIONAL_SECRET }}
        run: |
          if [ -n "$OPTIONAL_SECRET" ]; then
            echo "Secret is configured"
          else
            echo "Secret not found"
          fi

  # =====================================
  # Configuration Variables Demo
  # =====================================
  variables:
    name: Configuration Variables
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    
    # Job-level env vars (override workflow-level)
    env:
      DEPLOYMENT_ENV: ${{ inputs.environment }}
      REPO_VAR: ${{ vars.REPOSITORY_VAR }}
    
    steps:
      # Configuration variables from vars context
      - name: Use Variables
        run: |
          echo "Repository variable: ${{ vars.REPOSITORY_VAR }}"
          echo "Organization variable: ${{ vars.ORGANIZATION_VAR }}"
          echo "Environment variable: ${{ vars.ENVIRONMENT_VAR }}"
        env:
          REPOSITORY_VAR: ${{ vars.REPOSITORY_VAR }}
          ORGANIZATION_VAR: ${{ vars.ORGANIZATION_VAR }}
          ENVIRONMENT_VAR: ${{ vars.ENVIRONMENT_VAR }}
      
      # Dynamic configuration
      - name: Conditional Steps with Variables
        if: ${{ vars.ENABLE_TESTS == 'true' }}
        run: echo "Tests enabled via configuration variable"

  # =====================================
  # Environment Variable Scopes
  # =====================================
  env-scopes:
    name: Environment Variable Scopes
    runs-on: ubuntu-latest
    
    # Job-level env vars
    env:
      JOB_VAR: 'Available to all steps in this job'
      OVERRIDE_ME: 'Job level'
    
    steps:
      # Access all three scopes
      - name: Variable Precedence
        env:
          STEP_VAR: 'Only in this step'
          OVERRIDE_ME: 'Step level'
        run: |
          echo "Workflow: $APP_VERSION"
          echo "Job: $JOB_VAR"
          echo "Step: $STEP_VAR"
          echo "Override: $OVERRIDE_ME"
          # Step-level vars override job-level, job-level override workflow-level
      
      # Step vars don't leak to other steps
      - name: Scope Isolation
        run: |
          echo "STEP_VAR is not available here"
          echo "But JOB_VAR is: $JOB_VAR"
      
      # Set dynamic env vars for future steps
      - name: Set Dynamic Env Var
        run: echo "DYNAMIC_VALUE=Generated-$(date +%s)" >> $GITHUB_ENV
      
      - name: Use Dynamic Env Var
        run: |
          echo "Value from previous step: $DYNAMIC_VALUE"

  # =====================================
  # Large Secrets (Files)
  # =====================================
  large-secrets:
    name: Handle Large Secrets
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      # Store large secrets as GPG-encrypted files in repo
      - name: Decrypt Large Secret
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase="$SECRET_PASSPHRASE" \
            --output $HOME/my_secret.json my_secret.json.gpg
        env:
          SECRET_PASSPHRASE: ${{ secrets.LARGE_SECRET_PASSPHRASE }}
      
      - name: Use Decrypted Secret
        run: cat $HOME/my_secret.json

  # =====================================
  # Best Practices
  # =====================================
  best-practices:
    name: Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Security Tips
        run: |
          echo "✓ Use secrets for sensitive data (tokens, passwords)"
          echo "✓ Use variables for non-sensitive config"
          echo "✓ Use env vars for untrusted input (PR titles, etc)"
          echo "✓ Secrets are automatically masked in logs"
          echo "✓ Use least-privilege principle"
          echo "✓ Never echo secrets directly"
          echo "✓ Store large secrets as GPG-encrypted files"
