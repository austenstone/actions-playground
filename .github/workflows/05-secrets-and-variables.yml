name: 05. Secrets & Variables

# Secrets: Encrypted values for sensitive data (tokens, passwords, API keys)
# Variables: Non-sensitive configuration values
# Both are configured in: Settings > Secrets and variables > Actions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # Secrets
  secrets:
    name: Working with Secrets
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      # GITHUB_TOKEN is automatically provided
      - name: Use GITHUB_TOKEN
        run: |
          gh api /repos/${{ github.repository }} --jq '.name'
          echo "Stars: $(gh api /repos/${{ github.repository }} --jq '.stargazers_count')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Custom secrets (configure in repo settings)
      - name: Custom Secrets
        env:
          MY_SECRET: ${{ secrets.MY_SECRET }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "Secrets are automatically masked: $MY_SECRET"
          echo "Output: ***"
      
      # Conditional execution based on secret existence
      - name: Check Secret Exists
        env:
          OPTIONAL_SECRET: ${{ secrets.OPTIONAL_SECRET }}
        run: |
          if [ -n "$OPTIONAL_SECRET" ]; then
            echo "âœ“ Secret is configured"
          else
            echo "âœ— Secret not found"
          fi

  # Configuration Variables
  variables:
    name: Configuration Variables
    runs-on: ${{ vars.RUNNER || 'ubuntu-latest' }}
    
    steps:
      - name: Repository Variables
        run: |
          echo "Repo var: ${{ vars.REPOSITORY_VAR }}"
          echo "Org var: ${{ vars.ORGANIZATION_VAR }}"
          echo "Env var: ${{ vars.ENVIRONMENT_VAR }}"
      
      - name: Conditional Features
        if: ${{ vars.ENABLE_TESTS == 'true' }}
        run: echo "âœ“ Tests enabled via configuration"
      
      - name: Variable Usage
        run: |
          echo "Variables are for non-sensitive config:"
          echo "- Feature flags"
          echo "- Environment names"
          echo "- Non-secret endpoints"
          echo "- Build configurations"

  # Security Best Practices
  security:
    name: Security Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Safe Input Handling
        if: github.event_name == 'pull_request'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "âœ“ Using env vars prevents script injection"
          echo "PR: $PR_TITLE"
          echo "Author: $PR_AUTHOR"
      
      - name: Masking Sensitive Values
        run: |
          GENERATED_TOKEN="secret-$(date +%s)"
          echo "::add-mask::$GENERATED_TOKEN"
          echo "Token value: $GENERATED_TOKEN"
      
      - name: Security Tips
        run: |
          echo "ğŸ”’ Security Best Practices:"
          echo "âœ“ Use secrets for sensitive data"
          echo "âœ“ Use variables for non-sensitive config"
          echo "âœ“ Use env vars for untrusted input"
          echo "âœ“ Secrets are auto-masked in logs"
          echo "âœ“ Apply least-privilege principle"
          echo "âœ“ Never log secrets directly"
          echo "âœ“ Rotate secrets regularly"

  # Large Secrets (Files)
  large-secrets:
    name: Handling Large Secrets
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: About Large Secrets
        run: |
          echo "For large secrets (certs, keys, config files):"
          echo "1. GPG-encrypt and commit to repo"
          echo "2. Store passphrase in GitHub secrets"
          echo "3. Decrypt in workflow"
          echo ""
          echo "Example:"
          echo "  gpg --symmetric --cipher-algo AES256 secret.json"
          echo "  git add secret.json.gpg"
      
      - name: Decrypt Example (if file exists)
        run: |
          if [ -f "my_secret.json.gpg" ]; then
            gpg --quiet --batch --yes --decrypt \
              --passphrase="$SECRET_PASSPHRASE" \
              --output $HOME/my_secret.json my_secret.json.gpg
            echo "âœ“ Secret decrypted"
          else
            echo "â„¹ No encrypted file found (this is just a demo)"
          fi
        env:
          SECRET_PASSPHRASE: ${{ secrets.LARGE_SECRET_PASSPHRASE }}

  # Environment-Specific Secrets
  environment-secrets:
    name: Environment-Specific Secrets
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Use Environment Secrets
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Environment-specific secrets are scoped to this environment"
          echo "Configure in: Settings > Environments > ${{ inputs.environment }}"
