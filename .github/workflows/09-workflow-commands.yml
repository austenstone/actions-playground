name: 09. Workflow Commands

# Workflow commands provide special functionality through echo statements
# See: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # Setting Outputs
  outputs:
    name: Step & Job Outputs
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      status: ${{ steps.set-version.outputs.status }}
    
    steps:
      - name: Set step outputs
        id: set-version
        run: |
          echo "version=1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
      
      - name: Use outputs
        run: |
          echo "Version: ${{ steps.set-version.outputs.version }}"
          echo "Status: ${{ steps.set-version.outputs.status }}"
          echo "Time: ${{ steps.set-version.outputs.timestamp }}"
      
      - name: Multiline output
        id: multiline
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "content<<$EOF" >> $GITHUB_OUTPUT
          echo "Line 1: multiline" >> $GITHUB_OUTPUT
          echo "Line 2: output value" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
      
      - name: Use multiline output
        run: echo "${{ steps.multiline.outputs.content }}"

  use-outputs:
    name: Use Job Outputs
    runs-on: ubuntu-latest
    needs: outputs
    
    steps:
      - name: Access job outputs
        run: |
          echo "Version: ${{ needs.outputs.outputs.version }}"
          echo "Status: ${{ needs.outputs.outputs.status }}"

  # Environment Variables
  environment-vars:
    name: Dynamic Environment Variables
    runs-on: ubuntu-latest
    
    steps:
      - name: Set env vars for future steps
        run: |
          echo "BUILD_ID=build-${{ github.run_number }}" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +%s)" >> $GITHUB_ENV
      
      - name: Use env vars
        run: |
          echo "Build ID: $BUILD_ID"
          echo "Timestamp: $TIMESTAMP"
      
      - name: Multiline env var
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "CONFIG<<$EOF" >> $GITHUB_ENV
          echo "setting1=value1" >> $GITHUB_ENV
          echo "setting2=value2" >> $GITHUB_ENV
          echo "$EOF" >> $GITHUB_ENV
      
      - name: Use multiline env var
        run: echo "$CONFIG"

  # Annotations
  annotations:
    name: Notices, Warnings, Errors
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Notice annotations
        run: |
          echo "::notice::This is a notice"
          echo "::notice file=app.js,line=10::Function is deprecated"
          echo "::notice title=Build Success::Application built successfully"
      
      - name: Warning annotations
        run: |
          echo "::warning::This is a warning"
          echo "::warning file=config.yml,line=5::Using default configuration"
          echo "::warning title=Performance::Large file detected"
      
      - name: Error annotations
        run: |
          echo "::error::This is an error annotation (doesn't fail)"
          echo "::error file=test.js,line=25,col=10::Type mismatch"
          echo "Step continues after error annotation"
      
      - name: Debug messages
        run: |
          echo "::debug::Debug info (only visible with debug logging)"
          echo "::debug::Variable value: ${{ github.sha }}"

  # Log Grouping
  grouping:
    name: Log Groups
    runs-on: ubuntu-latest
    
    steps:
      - name: Grouped output
        run: |
          echo "::group::ðŸ“¦ Installing Dependencies"
          echo "Installing package 1..."
          echo "Installing package 2..."
          echo "Installing package 3..."
          echo "::endgroup::"
          
          echo "::group::ðŸ”¨ Building Application"
          echo "Compiling source..."
          echo "Bundling assets..."
          echo "::endgroup::"
          
          echo "::group::âœ… Tests Passed"
          echo "Unit tests: 50 passed"
          echo "Integration tests: 20 passed"
          echo "::endgroup::"

  # Masking Secrets
  masking:
    name: Mask Sensitive Values
    runs-on: ubuntu-latest
    
    steps:
      - name: Mask generated secrets
        run: |
          TOKEN="secret-$(date +%s)"
          echo "::add-mask::$TOKEN"
          echo "Token value: $TOKEN"
          echo "Output shows: ***"
      
      - name: Mask API key
        run: |
          API_KEY="sk-1234567890abcdef"
          echo "::add-mask::$API_KEY"
          echo "Using API key: $API_KEY"

  # System PATH
  system-path:
    name: Add to PATH
    runs-on: ubuntu-latest
    
    steps:
      - name: Add custom path
        run: |
          mkdir -p $HOME/custom-bin
          
          cat > $HOME/custom-bin/my-tool <<'EOF'
          #!/bin/bash
          echo "âœ… Custom tool executed"
          EOF
          chmod +x $HOME/custom-bin/my-tool
          
          echo "$HOME/custom-bin" >> $GITHUB_PATH
      
      - name: Use custom path
        run: my-tool

  # Job Summaries
  summaries:
    name: Job Summaries
    runs-on: ubuntu-latest
    
    steps:
      - name: Create summary
        run: |
          echo "# ðŸŽ‰ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Add test results table
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | âœ… Pass | 2m 30s |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | âœ… Pass | 5m 15s |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | âœ… Pass | 8m 45s |" >> $GITHUB_STEP_SUMMARY
      
      - name: Add code block
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’» Output" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "$ npm test" >> $GITHUB_STEP_SUMMARY
          echo "All tests passed!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Stop Commands
  stop-commands:
    name: Stop/Resume Commands
    runs-on: ubuntu-latest
    
    steps:
      - name: Stop command processing
        run: |
          echo "::warning::This warning is processed"
          
          stopMarker=$(uuidgen)
          echo "::stop-commands::$stopMarker"
          
          echo "::warning::This will NOT be a warning"
          echo "::error::This will NOT be an error"
          echo "Regular output still works"
          
          echo "::$stopMarker::"
          
          echo "::notice::Commands processing resumed"

  # Practical Example
  practical:
    name: Practical Example
    runs-on: ubuntu-latest
    
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Build
        id: build
        run: |
          echo "::group::ðŸ—ï¸  Building"
          
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          mkdir -p dist
          echo "Build output" > dist/app.js
          
          echo "::notice title=Build::Built version $VERSION"
          echo "::endgroup::"
      
      - name: Test
        run: |
          echo "::group::ðŸ§ª Testing"
          echo "Running tests..."
          echo "Tests passed: 42"
          echo "::endgroup::"
      
      - name: Deploy
        id: deploy
        run: |
          echo "::group::ðŸš€ Deploying"
          
          URL="https://example.com/${{ steps.build.outputs.version }}"
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          TOKEN="deploy-secret-123"
          echo "::add-mask::$TOKEN"
          
          echo "Deployed to: $URL"
          echo "::notice title=Deployment::Deployed to $URL"
          echo "::endgroup::"
      
      - name: Summary
        run: |
          echo "# âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY