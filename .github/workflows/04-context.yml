name: 04. Context

# Contexts provide information about workflow runs, jobs, steps, and the environment
# See: https://docs.github.com/en/actions/learn-github-actions/contexts

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # GitHub context - Information about the workflow run
  github-context:
    name: GitHub Context
    runs-on: ubuntu-latest
    
    steps:
      - name: Basic GitHub context
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run number: ${{ github.run_number }}"
      
      - name: Full GitHub context (JSON)
        run: echo '${{ toJSON(github) }}'

  # Job and Runner contexts
  job-runner-context:
    name: Job & Runner Context
    runs-on: ubuntu-latest
    
    steps:
      - name: Runner context
        run: |
          echo "OS: ${{ runner.os }}"
          echo "Arch: ${{ runner.arch }}"
          echo "Name: ${{ runner.name }}"
          echo "Temp dir: ${{ runner.temp }}"
          echo "Tool cache: ${{ runner.tool_cache }}"
      
      - name: Job context
        run: |
          echo "Job status: ${{ job.status }}"
          echo "Job container: ${{ job.container.id }}"
      
      - name: Full job context
        run: echo '${{ toJSON(job) }}'
      
      - name: Full runner context
        run: echo '${{ toJSON(runner) }}'

  # Steps context - Reference outputs from previous steps
  steps-context:
    name: Steps Context
    runs-on: ubuntu-latest
    
    steps:
      - name: Step 1 - Set output
        id: step1
        run: |
          echo "message=Hello from step 1" >> $GITHUB_OUTPUT
          echo "number=42" >> $GITHUB_OUTPUT
      
      - name: Step 2 - Use output
        id: step2
        run: |
          echo "Previous message: ${{ steps.step1.outputs.message }}"
          echo "Previous number: ${{ steps.step1.outputs.number }}"
          echo "result=success" >> $GITHUB_OUTPUT
      
      - name: View steps context
        run: echo '${{ toJSON(steps) }}'

  # Needs context - Use outputs from dependent jobs
  job-with-outputs:
    name: Job with Outputs
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      status: ${{ steps.set-version.outputs.status }}
    
    steps:
      - name: Set outputs
        id: set-version
        run: |
          echo "version=1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

  use-job-outputs:
    name: Use Job Outputs
    runs-on: ubuntu-latest
    needs: job-with-outputs
    
    steps:
      - name: Access previous job outputs
        run: |
          echo "Version: ${{ needs.job-with-outputs.outputs.version }}"
          echo "Status: ${{ needs.job-with-outputs.outputs.status }}"
      
      - name: View needs context
        run: echo '${{ toJSON(needs) }}'

  # Matrix context
  matrix-context:
    name: Matrix - ${{ matrix.os }} / Node ${{ matrix.node }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        node: [18, 20]
    
    steps:
      - name: Matrix values
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Node: ${{ matrix.node }}"
      
      - name: Strategy context
        run: |
          echo "Job index: ${{ strategy.job-index }}"
          echo "Job total: ${{ strategy.job-total }}"
      
      - name: Full contexts
        run: |
          echo '${{ toJSON(matrix) }}'
          echo '${{ toJSON(strategy) }}'

  # Inputs context (workflow_dispatch)
  inputs-context:
    name: Inputs Context
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Show inputs
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "All inputs: ${{ toJSON(inputs) }}"

  env-context:
    name: Environment Context
    runs-on: ubuntu-latest
    
    env:
      JOB_VAR: "job-level"
    
    steps:
      - name: Show env context
        env:
          STEP_VAR: "step-level"
        run: |
          echo "Env context: ${{ toJSON(env) }}"
          echo "Job var: $JOB_VAR"
          echo "Step var: $STEP_VAR"

  dump_contexts_to_log:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Dump GitHub context
        id: github_context_step
        run: echo '${{ toJSON(github) }}'
      - name: Dump job context
        run: echo '${{ toJSON(job) }}'
      - name: Dump steps context
        run: echo '${{ toJSON(steps) }}'
      - name: Dump runner context
        run: echo '${{ toJSON(runner) }}'
      - name: Dump strategy context
        run: echo '${{ toJSON(strategy) }}'
      - name: Dump matrix context
        run: echo '${{ toJSON(matrix) }}'
      - name: Dump env context
        run: printenv
