name: 07. Permissions

# Permissions control what GITHUB_TOKEN can access
# Default: read-all for public repos, read contents for private repos
# Best practice: Use least-privilege (only grant what's needed)
# See: https://docs.github.com/en/actions/security-guides/automatic-token-authentication

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Workflow-level permissions (apply to all jobs unless overridden)
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Using GITHUB_TOKEN
  github-token:
    name: GITHUB_TOKEN Basics
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: About GITHUB_TOKEN
        run: |
          echo "GITHUB_TOKEN is automatically provided"
          echo "No need to create or store it"
          echo "Scoped to the current repository"
          echo "Expires after the workflow run"
      
      - name: Use with GitHub CLI
        run: |
          gh repo view --json name,description
          gh api /repos/${{ github.repository }} --jq '.name'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check rate limits
        run: gh api rate_limit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Permission Levels
  read-only:
    name: Read-Only Permissions
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Read operations
        run: |
          echo "âœ“ Can read repository contents"
          echo "âœ— Cannot push commits or create releases"
          gh repo view --json name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  write-access:
    name: Write Permissions
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Write operations
        run: |
          echo "âœ“ Can push commits"
          echo "âœ“ Can create/update issues and PRs"
          echo "âœ“ Can create tags and releases"

  no-permissions:
    name: No Permissions
    runs-on: ubuntu-latest
    
    permissions: {}
    
    steps:
      - name: Restricted environment
        run: |
          echo "No GitHub API access"
          echo "Useful for untrusted code"
          echo "Or when no API access needed"

  # Specific Permission Types
  packages:
    name: Package Registry
    runs-on: ubuntu-latest
    if: false # Reference only
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Login to GitHub Packages
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
      - name: Push to registry
        run: |
          docker build -t ghcr.io/${{ github.repository }}:latest .
          docker push ghcr.io/${{ github.repository }}:latest

  oidc-token:
    name: OIDC Token (Cloud Access)
    runs-on: ubuntu-latest
    if: false # Reference only
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/MyRole
          aws-region: us-east-1
      
      - name: Access AWS
        run: aws sts get-caller-identity

  security-scanning:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: false # Reference only
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Run security scan
        run: echo "Running security analysis..."
      
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  # Permission Reference
  permissions-reference:
    name: Permission Reference
    runs-on: ubuntu-latest
    
    steps:
      - name: Available Permissions
        run: |
          echo "ðŸ“š Available Permissions:"
          echo ""
          echo "actions          - Cancel/rerun workflows"
          echo "attestations     - Create attestations"
          echo "checks           - Create check runs"
          echo "contents         - Push commits, tags, releases"
          echo "deployments      - Create deployments"
          echo "discussions      - Create/update discussions"
          echo "id-token         - Request OIDC JWT token"
          echo "issues           - Create/update issues"
          echo "packages         - Publish to GitHub Packages"
          echo "pages            - Deploy to GitHub Pages"
          echo "pull-requests    - Create/update pull requests"
          echo "security-events  - Upload code scanning results"
          echo "statuses         - Create commit statuses"
          echo ""
          echo "Values: read, write, none"
          echo "Job-level overrides workflow-level"
          echo ""
          echo "See: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token"
