name: 07. Permissions

# Permissions control what GITHUB_TOKEN can access
# Default: read-all for public repos, read contents for private repos
# Best practice: Use least-privilege (only grant what's needed)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Workflow-level permissions (apply to all jobs unless overridden)
permissions:
  contents: read        # Read repository contents
  pull-requests: write  # Create/update PRs
  issues: write         # Create/update issues

jobs:
  default-permissions:
    runs-on: ubuntu-latest
    # Default permissions are granted when none are specified
    steps:
      - uses: actions/checkout@v4
      - name: Test Default Access
        run: |
          echo "Can read repo contents (inherited from workflow)"
          gh api /repos/${{ github.repository }}
        env:
          # You must pass the GITHUB_TOKEN to use the gh cli
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  override-permissions:
    runs-on: ubuntu-latest
    
    # Job-level permissions override workflow-level
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Create Issue Comment
        run: |
          echo "This job can write issues but not PRs"
          gh issue comment 1 --body "Test comment"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Restrictive Permissions
  no-permissions:
    name: No Permissions
    runs-on: ubuntu-latest
    
    # Disable all permissions
    permissions: {}
    
    steps:
      - name: No API Access
        run: |
          echo "This job has no GitHub API access"
          echo "Useful for untrusted code or when no API calls needed"

  read-only:
    name: Read-Only Access
    runs-on: ubuntu-latest
    
    permissions:
      contents: read # Read only permissions (best practice)
    
    steps:
      - uses: actions/checkout@v4
      - name: Can read but not write
        run: gh api /repos/${{ github.repository }} --jq '.name'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  write-access:
    name: Write Access
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write       # Push commits, create tags
      pull-requests: write  # Create/update PRs
      issues: write         # Create/update issues
    
    steps:
      - uses: actions/checkout@v4
      - name: Write Operations
        run: |
          echo "Can perform write operations"
          # git tag v1.0.0
          # git push origin v1.0.0

  # ID Token Permission (OIDC)
  oidc-token:
    name: OIDC Token Access
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write  # Request OIDC JWT token
      contents: read
    
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/MyRole
          aws-region: us-east-1
      - run: aws sts get-caller-identity

  packages:
    name: Package Registry Access
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write  # Publish to GitHub Packages
    
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - run: |
          docker build -t ghcr.io/${{ github.repository }}:latest .
          docker push ghcr.io/${{ github.repository }}:latest

  # Security Permissions
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write  # Upload SARIF results
    
    steps:
      - uses: actions/checkout@v4
      - run: echo "Running security scan"
      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  all-permissions-reference:
    name: All Permissions Reference
    runs-on: ubuntu-latest
    if: false # Reference only
    
    # All Available Permissions
    # See: https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#permissions
    permissions:
      actions: write             # Cancel/rerun workflows
      attestations: write        # Create attestations
      checks: write              # Create check runs
      contents: write            # Push commits, create tags
      deployments: write         # Create deployments
      id-token: write            # Request OIDC token
      issues: write              # Create/update issues
      discussions: write         # Create/update discussions
      packages: write            # Publish packages
      pages: write               # Deploy to GitHub Pages
      pull-requests: write       # Create/update PRs
      repository-projects: write # Create/update projects
      security-events: write     # Upload code scanning results
      statuses: write            # Create commit statuses
    
    steps:
      - run: echo "All permissions granted"
