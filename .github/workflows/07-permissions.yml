name: 07. Permissions

# Permissions control what GITHUB_TOKEN can access
# Default: read-all for public repos, read contents for private repos
# Best practice: Use least-privilege (only grant what's needed)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Workflow-level permissions (apply to all jobs unless overridden)
permissions:
  contents: read        # Read repository contents
  pull-requests: write  # Create/update PRs
  issues: write         # Create/update issues

jobs:
  # =====================================
  # Default Permissions
  # =====================================
  default-permissions:
    name: Default Permissions
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Test Default Access
        run: |
          echo "Can read repo contents (inherited from workflow)"
          gh api /repos/${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =====================================
  # Override Permissions
  # =====================================
  override-permissions:
    name: Override Job Permissions
    runs-on: ubuntu-latest
    
    # Job-level permissions override workflow-level
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Create Issue Comment
        run: |
          echo "This job can write issues but not PRs"
          # gh issue comment 1 --body "Test comment"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =====================================
  # Restrictive Permissions
  # =====================================
  no-permissions:
    name: No Permissions
    runs-on: ubuntu-latest
    
    # Disable all permissions
    permissions: {}
    
    steps:
      - name: No API Access
        run: |
          echo "This job has no GitHub API access"
          echo "Useful for untrusted code or when no API calls needed"

  # =====================================
  # Read-Only Permissions
  # =====================================
  read-only:
    name: Read-Only Access
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Read Repository Data
        run: |
          echo "Can read but not write"
          gh api /repos/${{ github.repository }} --jq '.name'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =====================================
  # Write Permissions
  # =====================================
  write-access:
    name: Write Access
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write       # Push commits, create tags
      pull-requests: write  # Create/update PRs
      issues: write         # Create/update issues
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Write Operations
        run: |
          echo "Can perform write operations"
          # Example: Create a tag
          # git tag v1.0.0
          # git push origin v1.0.0

  # =====================================
  # ID Token Permission (OIDC)
  # =====================================
  oidc-token:
    name: OIDC Token Access
    runs-on: ubuntu-latest
    if: false # Disabled - enable when needed
    
    permissions:
      id-token: write  # Request OIDC JWT token
      contents: read
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/MyRole
          aws-region: us-east-1
      
      - name: Access AWS
        run: aws sts get-caller-identity

  # =====================================
  # Package Permissions
  # =====================================
  packages:
    name: Package Registry Access
    runs-on: ubuntu-latest
    if: false # Disabled - enable when publishing packages
    
    permissions:
      contents: read
      packages: write  # Publish to GitHub Packages
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to GitHub Container Registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
      - name: Build and Push
        run: |
          docker build -t ghcr.io/${{ github.repository }}:latest .
          docker push ghcr.io/${{ github.repository }}:latest

  # =====================================
  # Deployment Permissions
  # =====================================
  deploy:
    name: Deployment Access
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      deployments: write  # Create deployment status
    
    environment:
      name: production
    
    steps:
      - name: Deploy Application
        run: echo "Deploying with deployment permissions"

  # =====================================
  # Security Permissions
  # =====================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write  # Upload SARIF results
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Security Scan
        run: echo "Security scanning enabled"

  # =====================================
  # All Available Permissions
  # =====================================
  all-permissions-reference:
    name: All Permissions Reference
    runs-on: ubuntu-latest
    if: false # Reference only
    
    permissions:
      actions: write             # Cancel/rerun workflows
      attestations: write        # Create attestations
      checks: write              # Create check runs
      contents: write            # Push commits, create tags
      deployments: write         # Create deployments
      id-token: write            # Request OIDC token
      issues: write              # Create/update issues
      discussions: write         # Create/update discussions
      packages: write            # Publish packages
      pages: write               # Deploy to GitHub Pages
      pull-requests: write       # Create/update PRs
      repository-projects: write # Create/update projects
      security-events: write     # Upload code scanning results
      statuses: write            # Create commit statuses
    
    steps:
      - run: echo "All permissions granted"

  # =====================================
  # Best Practices Demo
  # =====================================
  best-practices:
    name: Best Practices
    runs-on: ubuntu-latest
    
    # Minimal permissions needed for this job
    permissions:
      contents: read
    
    steps:
      - name: Security Guidelines
        run: |
          echo "✓ Grant minimum permissions needed"
          echo "✓ Override at job level when needed"
          echo "✓ Use {} to disable all permissions"
          echo "✓ Separate jobs by permission needs"
          echo "✓ Use environments for sensitive operations"
          echo "✓ Review permissions regularly"
          echo "✓ Document why permissions are needed"
